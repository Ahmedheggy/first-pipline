image: docker:24.0.7

variables:
  DOCKER_HOST: unix:///var/run/docker.sock
  DOCKER_TLS_CERTDIR: ""
  IMAGE_NAME: first_pipeline
  CONTAINER_NAME: flask_app

stages:
  - build
  - deploy

before_script:
  - apk add --no-cache docker-compose
  - docker --version
  - docker-compose --version

build_job:
  stage: build
  script:
    # Secure Docker Hub login with token
    - echo "$DOCKER_TOKEN" | docker login -u "ahmedheggy" --password-stdin
    
    # Build and push the image
    - docker build -t ahmedheggy/$IMAGE_NAME:$CI_COMMIT_SHA .
    - docker push ahmedheggy/$IMAGE_NAME:$CI_COMMIT_SHA
    
    # Also tag as 'latest' (optional)
    - docker tag ahmedheggy/$IMAGE_NAME:$CI_COMMIT_SHA ahmedheggy/$IMAGE_NAME:latest
    - docker push ahmedheggy/$IMAGE_NAME:latest
  tags:
    - docker

deploy:
  stage: deploy
  only:
    - main
  script:
    # Login to Docker Hub
    - echo "$DOCKER_TOKEN" | docker login -u "ahmedheggy" --password-stdin
    
    # Pull the latest image
    - docker pull ahmedheggy/first_pipeline:$CI_COMMIT_SHA
    
    # Tag the image for compose
    - docker tag ahmedheggy/first_pipeline:$CI_COMMIT_SHA ahmedheggy/first_pipeline:latest
    
    # Deploy using compose
    - docker-compose down --remove-orphans || true
    - TAG=$CI_COMMIT_SHA docker-compose up -d
    
    # Verify deployment
    - sleep 10
    - docker-compose ps
    - docker-compose logs --tail=50
rollback:
  script:
    - docker-compose pull web
    - docker-compose up -d